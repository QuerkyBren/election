<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Versutian Elections</title>
        <link rel="icon" type="image/png" href="versutian.png" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha256-rr9hHBQ43H7HSOmmNkxzQGazS/Khx+L8ZRHteEY1tQ4=" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
        <style>
            .card:hover {
                background-color: #ededed;
            }
            .card-inverse {
                background-color: #333; !important
                border-color: #333;
            }
            .card-inverse:hover {
                background-color: #333; !important
                border-color: #333;
            }
        </style>
    </head>
    <body>
        <header class="jumbotron jumbotron-fluid">
            <div class="container">
                <h1 class="display-3"><b>Versutian</b> Elections</h1>
                <p class="lead">Welcome to the official voting site for the Versutian Federation.</p>
                <p>Here, you may cast your ballot for current elections to participate in our democracy with a simple two step process &mdash; no registration required.</p>
                <a class="btn btn-secondary" href="faq.html">Learn more</a>
            </div>
        </header>
        
        <section id="elections" class="container">
            <div class="text-center">
                <span class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></span>
                <span class="sr-only">Loading...</span>
            </div>
        </section>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js" integrity="sha256-jJlsVPlSwQyGokYi0JgmrFRihc7ILE3Id8AB0dpr0JA=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="https://www.gstatic.com/firebasejs/4.0.0/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.0.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.0.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.0.0/firebase-database.js"></script>
        <script src="http://kjur.github.io/jsrsasign/jsrsasign-latest-all-min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha256-gL1ibrbVcRIHKlCO5OXOPC/lZz/gpdApgQAzskqqXp8=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha256-+kIbbrvS+0dNOjhmQJzmwe/RILR/8lb/+4+PUNVW09k=" crossorigin="anonymous"></script>
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyDUCZPMORvRZ1_ZWMlLMpEi5q9PQIAaT4o",
                authDomain: "versutian.firebaseapp.com",
                databaseURL: "https://versutian.firebaseio.com",
                projectId: "versutian",
                storageBucket: "versutian.appspot.com",
                messagingSenderId: "158551980529"
            };
            firebase.initializeApp(config);
            var nationName;
            var internalName;
            var verificationCode;
            var accessLevel = "CITIZEN";
            var officials = ["north_arkana", "asairia", "akohos"];
            var protectors = ["alamei"];
            var sub = 'versutian@appspot.gserviceaccount.com';
            var sPKCS8PEM = '-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC9BUKL5OmnfAi6\n2TqOInGOCJ6aq44jC4503Y+NspbEkYF50PuzgtDNA356ZE987iKWoAOpLbRu9emG\nfeThjc+5CgTbJ0H8LPAfNb8uWBRd1JQm4X7nz5q9dDPkFt2+bG7Fxx6szaMKpRlN\n3w0ydk+7RIb+viizqym/XinTnW5KiDMPLbur+L1nlswYdTW445y16rbp4nTHKDGN\nYgqe72LdU0i5G80T2ZLS2zgpDD9myp0YU3k3MdtYthi7w7BnkBwAoB/zdg1NNi7y\ndXhQ684vSxRk972y+yyTzs42LOkzE0OIAc9/qnS8Kdgx0uhfnQirlO1Y3Qs+7Mo1\nUnQYggYtAgMBAAECggEAGeg7Jz5wUf7bmXSFpI6O/tcqmetyl1YRp+3oK5UzOezx\nkJc2sHN5F+hnMPJHvMlM31U+OzVi+iRlZgQiV1HfCy8W3EzErAIixTxSIFF9NSEa\nTzvv72jSfi4LoLMLoHpvMldo2mly89YOIlC0l9qEchfh4s+Ad6O5nJuU4wa8Y6WL\nkHQLzCS/mb38IlBL+jR4BfltFBCowWSDcXeTAn5rwStfSL/fJLNzIFvk77SdIh6Q\n4f3QAkTNYKQ0xGW2D12xlu9e9hzXLzwQWFHfigxbLSYYliCifjQVPXHPODwMZtsw\nKcFQc+wNfv7ECOagVY/+gnwcw+/yAcvI0GtvpZgihwKBgQD4MsxI6r4PbCwwWL8p\nrhFKXvMVftlXsjL1N0/EAE2QK3tOq0jgZ4iGnX0E3nTnyQxM4JIdOd/QxTU/jBLD\nHNpxzPk6mPDgdWlvn6Jod2BrGc4Dv/QaAIX+IMyYtz4fz6OfhehKDMQSihMZ0s/h\nuBy7qyY3MJ1a81XkihuBu0ehmwKBgQDC9kUG2VMVMdH7HXpGSByvfj3WpFBExDXO\nioK5BCLn8/lWUZ7jBhpN65wX+K5f7naty6Kxh5B+nW7hv1+wdOkjCZn9CZYU1Ga3\nMKznlOt3yfhrgpDaUlqiq8Ac9MlKjXE8cPqiwRMsZptLrtXY1dxwU+7/HY4qI7ld\nVXrcKXM31wKBgQCwhdh7J9FjQKkw/X2AVFfh0CQNLrm/wHKzqtIlcZ24ouRBMFtV\nlu0n6Myo8Nqum3QPHU1uUeIYJppXhvU1JclLVOARSANRcNA7Xorwx66gnarDSft/\nns2tz4AUQYeCsngKFf/+4pN1KBSrsh69x+dPpks4x2+y5ww4ze0AWMV6bwKBgGZk\nFl6Bdpvz/VbH5XbR2pbkUy/OPgXPkn61ye/HV1nAjVujJDIQ+3Ge4uzIAzSItbWS\n9BAOpXmJzzkqW+P9ko9/NGtrRHIOFx/wpW4+jOftn9U+zjqK8+TpFM1gVfMck7Lt\nlwQxKJOyE69M1Cy8LLilrCg56ncBKhH1mb/U2RkjAoGBALgBnHMIzhNQHJJcPEPk\nuLVnF+w3rFMH1m/JEngsxYp96BNLNcAoD/vA+Ie57+0ArGmAyQ5rs7jZAFiC5/pc\nB3wojXWg86UzK1h/EvthXYPqH+ukw0aoDuwiXBIIphxP5UOSnwHOFp/MWQyYNLLq\n1fs92SrrtEqiYhDSkAUCZxwb\n-----END PRIVATE KEY-----\n';
            var kid = '71485c8500b96d3a3ba4c46fdce05bc81ed0b55f';
            var token;
            var verifyurl;

            function initApp() {
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        internalName = user.uid;
                        var nameXML = request("https://www.nationstates.net/cgi-bin/api.cgi?nation=" + internalName + "&q=name", true);
                        nationName = nameXML.getElementsByTagName("NAME").item(0).textContent;
                        var electionsData = firebase.database().ref('elections/');
                        electionsData.on('value', function(snapshot) {
                            clearElections();
                            snapshot.forEach(function(childSnapshot) {
                                updateElectionsData(childSnapshot);
                            });
                        });
                        var elections = document.getElementById('elections');
                        if (accessLevel === "OFFICIAL" || accessLevel === "PROTECTOR") {
                            elections.innerHTML += '<hr>';
                            elections.innerHTML += '<h2>Create new election</h2>';
                            elections.innerHTML += '<form><div class="form-group"><input type="text" class="form-control" id="election-name" placeholder="Election name"></div><div class="form-group"><label>Candidates</label><input type="text" class="form-control" id="election-name" placeholder="Nation name"> <br><input type="text" class="form-control" id="election-name" placeholder="Nation name"></div></form> <br><button class="btn btn-primary" onclick="add()">Create election</button><br>';
                        }
                    } else {
                        var elections = document.getElementById('elections');
                        elections.innerHTML = '<h1>Login with NationStates</h1>';
                        elections.innerHTML += '<div id="alert"></div>';
                        elections.innerHTML += '<form>';
                        elections.innerHTML += '<div class="form-group" id="nation-name-group">';
                        elections.innerHTML += '<input type="text" class="form-control form-control-lg" id="nation-name" aria-describedby="nationHelpBlock" placeholder="Nation name">';
                        elections.innerHTML += '<div id="nation-name-feedback"></div>';
                        elections.innerHTML += '<p id="nationHelpBlock" class="form-text text-muted">';
                        elections.innerHTML += 'Your nation\'s short name, as it is displayed on NationStates, for example, <b>Akohos</b>.';
                        elections.innerHTML += '</p>';
                        elections.innerHTML += '</div>';
                        elections.innerHTML += '</form>';
                        elections.innerHTML += '<br>';
                        elections.innerHTML += '<iframe src="https://embed.nationstates.net/page=verify_login#proof_of_login_checksum" style="border:none; height: 33vh; width: 100%" id="ns-embed"></iframe>';
                        elections.innerHTML += '<div id="embed-text"><p>If there is an error, or you need to switch nations, <button id="embed-switch" class="btn btn-secondary">login first.</button></p></div>';
                        elections.innerHTML += '<br>';
                        elections.innerHTML += '<form>';
                        elections.innerHTML += '<div class="form-group" id="verification-code-group">';
                        elections.innerHTML += '<input type="text" class="form-control" id="verification-code" aria-describedby="codeHelpBlock" placeholder="Code">';
                        elections.innerHTML += '<div id="verification-code-feedback"></div>';
                        elections.innerHTML += '<p id="codeHelpBlock" class="form-text text-muted">';
                        elections.innerHTML += 'Copy the code you see from the NationStates.net page into this box.';
                        elections.innerHTML += '</p>';
                        elections.innerHTML += '</div>';
                        elections.innerHTML += '</form>';
                        elections.innerHTML += '<br>';
                        elections.innerHTML += '<button class="btn btn-primary" onclick="verify()">Login</button>';
                        elections.innerHTML += '<br><br>';
                        document.getElementById('embed-switch').addEventListener('click', loginembed, false);
                    }
                });
            }
            
            function verify() {
                document.getElementById('nation-name-feedback').innerHTML = '';
                document.getElementById('nation-name-group').classList.remove('has-warning');
                document.getElementById('verification-code-feedback').innerHTML = '';
                document.getElementById('verification-code-group').classList.remove('has-warning');
                nationName = document.getElementById('nation-name').value;
                internalName = nationName.toLowerCase().replace(/ /g, "_");
                verificationCode = document.getElementById('verification-code').value;
                var invalid = false;
                if (nationName == null || nationName.length < 2) {
                    document.getElementById('nation-name-group').classList.add('has-warning');
                    document.getElementById('nation-name-feedback').innerHTML = '<div class="form-control-feedback">Something\'s not right about that nation name.</div>';
                    invalid = true;
                }
                if (verificationCode == null || verificationCode == "") {
                    denyCode();
                    invalid = true;
                } else {
                    var response = request("https://www.nationstates.net/cgi-bin/api.cgi?a=verify&nation=" + nationName + "&checksum=" + verificationCode, false);
                    if (response != 1) {
                        denyCode();
                        invalid = true;
                    } else {
                        invalid = false;
                    }
                }
                if (invalid) {
                    return;
                }
                var oHeader = {alg: 'RS256', kid: kid, typ: 'JWT'};
                var oPayload = {};
                var tNow = KJUR.jws.IntDate.get('now');
                var tEnd = KJUR.jws.IntDate.get('now + 1hour');
                oPayload.aud = 'https://identitytoolkit.googleapis.com/google.identity.identitytoolkit.v1.IdentityToolkit';
                oPayload.exp = tEnd;
                oPayload.iat = tNow;
                oPayload.iss = sub;
                oPayload.sub = sub;
                oPayload.user_id = internalName;
                oPayload.scope = 'https://www.googleapis.com/auth/identitytoolkit';
                var sHeader = JSON.stringify(oHeader);
                var sPayload = JSON.stringify(oPayload);
                var token = KJUR.jws.JWS.sign(null, sHeader, sPayload, sPKCS8PEM, 'notasecret');
                firebase.auth().signInWithCustomToken(token).catch(function(error) {
                    console.error(error);
                });
                var elections = document.getElementById('elections');
                if (officials.indexOf(internalName) != -1) {
                    accessLevel = "OFFICIAL";
                } else if (protectors.indexOf(internalName) != -1) {
                    accessLevel = "PROTECTOR";
                }
                
            }
            
            function denyCode() {
                document.getElementById('verification-code-group').classList.add('has-warning');
                document.getElementById('verification-code-feedback').innerHTML = '<div class="form-control-feedback">Your verification code was not approved. Generate a new code.</div>';
            }
            
            /*
            function addTest() {
                var electionData = {
                    election: "Delegate",
                    options: {
                        akohos: {
                            humantus: true
                        },
                        opponent: {
                            other_voter: true
                        }
                    }
                };
                
                var electionId = firebase.database().ref().child('elections').push().key;
                firebase.database().ref('elections/' + electionId).set(electionData);
            }
            */
            
            function updateElectionsData(data) {
                firebase.database().ref('/elections/' + data.key + '/options').once('value').then(function(snapshot) {
                    var elections = document.getElementById('elections');
                    var electionSection = document.createElement('div');
                    electionSection.innerHTML = '<hr><h2>' + data.val().election + '</h2>';
                    elections.appendChild(electionSection);
                    //var pieChart = document.createElement('div');
                    //pieChart.setAttribute('id', 'pie-' + data.key);
                    firebase.database().ref('/citizens/' + internalName + '/' + data.key + '/choices/').once('value').then(function(voted) {
                        var votedCounter = voted.numChildren();
                        if (votedCounter === data.val().votes) { // if the person voted,
                            var youVoted = document.createElement('p');
                            youVoted.innerHTML = 'You voted for ';
                            voted.forEach(function(candidate) {
                                votedCounter--;
                                if (votedCounter === 0) {
                                    youVoted.innerHTML += candidate.key + '.';
                                } else if (votedCounter === 1) {
                                    youVoted.innerHTML += candidate.key + 'and ';
                                } else {
                                    youVoted.innerHTML += candidate + ', ';
                                }
                            });
                            electionSection.appendChild(youVoted);
                        } else { // if they still need to vote
                            var electionInner = document.createElement('div')
                            electionInner.classList.add('card-columns');
                            electionSection.appendChild(electionInner);
                            snapshot.forEach(function(candidate) {
                                var card = document.createElement('div');
                                card.setAttribute('id', data.key + '-' + candidate.key);
                                card.classList.add('card');
                                firebase.database().ref('/citizens/' + internalName + '/' + data.key + '/choices/' + candidate.key).once('value').then(function(snapshot) {
                                    if (snapshot.val()) {
                                        card.classList.add('card-inverse');
                                    }
                                });
                                electionInner.appendChild(card);
                                var img = document.createElement('img');
                                img.setAttribute('class', 'card-img-top img-fluid');
                                var candidateXML = request("https://www.nationstates.net/cgi-bin/api.cgi?nation=" + candidate.key + "&q=flag+name", true);
                                var flagSrc = candidateXML.getElementsByTagName("FLAG").item(0).textContent;
                                img.setAttribute('src', flagSrc);
                                card.appendChild(img);
                                var cardBlock = document.createElement('div');
                                cardBlock.classList.add('card-block');
                                card.appendChild(cardBlock);
                                var candidateName = candidateXML.getElementsByTagName("NAME").item(0).textContent;
                                cardBlock.innerHTML += '<h4 class="card-title">' + candidateName + '</h4>';
                                document.getElementById(data.key + '-' + candidate.key).addEventListener('click', function() {
                                    firebase.database().ref('/elections/' + data.key + '/options/' + candidate.key + '/' + internalName).set(true);
                                    firebase.database().ref('/citizens/' + internalName + '/' + data.key + '/choices/' + candidate.key).set(true)
                                }, false);
                            });
                            var element = document.createElement('br');
                            electionSection.appendChild(element);
                            var element = document.createElement('br');
                            electionSection.appendChild(element);
                        }
                    });
                });
            }
            
            function clearElections() {
                elections.innerHTML = '<h1>Vote</h1>';
                elections.innerHTML += '<p class="lead">Vote on these elections, ' + nationName + '.</p><button class="btn btn-secondary" onclick="signOut()">sign out</button><br><br>';
            }
            
            function request(url, xml) {
                var request = new XMLHttpRequest();
                request.open("GET", url, false);
                request.send();
                if (xml) {
                    return request.responseXML;
                } else {
                    return request.responseText;
                }
            }
            
            function loginembed() {
                document.getElementById('ns-embed').src = "https://nationstates.net/page=login";
                document.getElementById('embed-switch').removeEventListener('click', loginembed, false);
                document.getElementById('embed-text').innerHTML = '<p>Once you have logged in, <button id="embed-switch" class="btn btn-secondary">verify your nation.</button></p>';
                document.getElementById('embed-switch').addEventListener('click', verifyembed, false);
            }
            
            function verifyembed() {
                document.getElementById('ns-embed').src = "https://embed.nationstates.net/page=verify_login#proof_of_login_checksum";
                document.getElementById('embed-switch').removeEventListener('click', verifyembed, false);
                document.getElementById('embed-text').innerHTML = '<p>If there is an error, or you need to switch nations, <button id="embed-switch" class="btn btn-secondary">login first.</button></p>';
                document.getElementById('embed-switch').addEventListener('click', loginembed, false);
            }
            
            function vote() {
                /*
                var innerVote = document.getElementById('inner-vote');
                innerVote.innerHTML = '<p class="card-text">Thank you for voting!</p>';
                innerVote.innerHTML += '<div class="text-xs-center"><b>Akohos</b> 100%</div>';
                innerVote.innerHTML += '<progress class="progress" value="100" max="100"></progress>';
                innerVote.innerHTML += '<div class="text-xs-center"><b>Opponent</b> 0%</div>';
                innerVote.innerHTML += '<progress class="progress" value="0" max="100"></progress>';
                */
            }
            
            function signOut() {
                firebase.auth().signOut();
            }
            
            window.onload = function() {
                initApp();
            }
        </script>
    </body>
</html>
